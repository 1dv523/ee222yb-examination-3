<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="css/style.css">
    <!-- <script type="module" src="js/chat.js"></script> -->
    <template id="issueTemplate">
      <div class="issue">
        <div class="header"></div>
        <div class="content"></div>
        <div class="properties"></div>
      </div>
    </template>
  </head>
  <body>

    <!-- ngrok redirect test -->
    <!-- <form method="post" action="http://18c12bd2.ngrok.io/payload">
      <button>test</button>
    </form> -->

    <h1></h1>

    <div id="issueContainer"></div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io()
      const issueContainer = document.querySelector('#issueContainer')

      // first issue get
      socket.on('issues', data => {
        document.body.querySelector('h1').textContent = 'Issues of ' + data.repo
        while(issueContainer.lastChild) {
          issueContainer.lastChild.remove()
        }
        for(const issue of data.issues) {
          // console.log(issue)
          addIssue(issue)
        }
      })

      // server received an udpate via webhook and forwarded it
      // socket.on('issueChange', data => {
      //   console.log(data)
      // })

      
      const addIssue = data => {
        issueContainer.appendChild(issueTemplate.content.cloneNode(true))
        const newIssue = issueContainer.lastElementChild

        newIssue.querySelector('.header').textContent = '#' + data.number + ' ' + data.title
        newIssue.querySelector('.content').textContent = data.body
        const properties = newIssue.querySelector('.properties')
        properties.textContent = 'Created by: ' + data.user.login + ' at ' + data.created_at
        properties.textContent += ', ' + data.comments + ' comments'
        // data.assignees.forEach(assignee => {
        //   newIssue.querySelector('.properties').textContent += assignee.login + ', '
        // })

        newIssue.classList.add(data.state)
      }

      socket.on('', data => {
        
      })
    </script>
  
  </body>
</html>